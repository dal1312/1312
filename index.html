<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
  <title>NPC Translator</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0f0f17">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="NPC Translator">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@400;700&family=Noto+Sans+Hebrew:wght@400;700&display=swap" rel="stylesheet">
  <!-- Librerie -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.2/mammoth.browser.min.js"></script>
  <script src="https://unpkg.com/tesseract.js@5/dist/tesseract.min.js"></script>
  <style>
    :root {
      --primary: #a855f7;
      --primary-glow: rgba(168, 85, 247, 0.5);
      --secondary: #7c3aed;
      --bg-dark: #0a0a0f;
      --bg-surface: #12121a;
      --bg-surface-light: #1e1e2a;
      --text: #e0e0ff;
      --text-dim: #a0a0cc;
      --border: #2a2a3a;
      --error: #f87171;
      --success: #4ade80;
      --gradient: linear-gradient(135deg, #7c3aed, #a855f7, #d946ef);
      --gradient-glow: 0 0 20px rgba(168, 85, 247, 0.3);
    }
    .light-theme {
      --bg-dark: #f0f0ff;
      --bg-surface: #ffffff;
      --bg-surface-light: #f0f0fa;
      --text: #1a1a2a;
      --text-dim: #4a4a6a;
      --border: #d0d0e0;
    }
    @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-5px); } 100% { transform: translateY(0px); } }
    @keyframes pulse { 0% { box-shadow: 0 0 0 0 var(--primary-glow); } 70% { box-shadow: 0 0 0 10px rgba(168,85,247,0); } 100% { box-shadow: 0 0 0 0 rgba(168,85,247,0); } }
    @keyframes glow { from { text-shadow:0 0 10px var(--primary),0 0 20px var(--primary); } to { text-shadow:0 0 15px var(--primary),0 0 30px var(--secondary); } }
    body {
      background: var(--bg-dark);
      color: var(--text);
      min-height: 100vh;
      padding: 1.5rem;
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      position: relative;
      overflow-x: hidden;
      -webkit-tap-highlight-color: transparent;
      margin: 0;
      transition: background 0.3s, color 0.3s;
    }
    body::before {
      content: '';
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: linear-gradient(rgba(168,85,247,0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(168,85,247,0.03) 1px, transparent 1px);
      background-size: 50px 50px;
      pointer-events: none;
      z-index: -1;
    }
    main { max-width: 1400px; margin: 0 auto; position: relative; z-index: 1; }
    h1 {
      text-align: center; color: white; font-size: 3.5rem; margin-bottom: 1.5rem;
      font-weight: 800; letter-spacing: 2px; text-transform: uppercase;
      animation: glow 3s ease-in-out infinite alternate;
      position: relative; display: inline-block; left: 50%; transform: translateX(-50%);
      white-space: nowrap;
    }
    h1::before {
      content: 'NPC Translator'; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      color: var(--primary); opacity: 0.3; filter: blur(8px); z-index: -1;
    }
    h1 i { color: var(--primary); margin: 0 0.5rem; font-size: 3rem; animation: float 3s ease-in-out infinite; }
    .badge-container { display: flex; gap: 0.8rem; justify-content: center; flex-wrap: wrap; margin-bottom: 2rem; }
    .badge {
      background: linear-gradient(135deg, rgba(124,58,237,0.2), rgba(168,85,247,0.2));
      border: 1px solid var(--primary); color: var(--text); padding: 0.5rem 1.2rem; border-radius: 30px;
      font-size: 0.9rem; backdrop-filter: blur(5px); box-shadow: 0 0 15px rgba(168,85,247,0.2); transition: all 0.3s ease;
    }
    .badge:hover { transform: translateY(-2px); box-shadow: 0 5px 20px var(--primary-glow); background: linear-gradient(135deg, rgba(124,58,237,0.3), rgba(168,85,247,0.3)); }
    .badge i { margin-right: 0.5rem; color: var(--primary); }
    .language-selector {
      display: flex; gap: 1rem; justify-content: center; align-items: center; flex-wrap: wrap; margin-bottom: 2rem;
      background: var(--bg-surface); padding: 1.5rem; border-radius: 60px; border: 1px solid var(--border);
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }
    select {
      background: var(--bg-surface-light); color: var(--text); border: 1px solid var(--border); padding: 0.8rem 2rem;
      border-radius: 30px; font-size: 1rem; cursor: pointer; min-width: 180px; appearance: none;
      background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23a855f7' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><polyline points='6 9 12 15 18 9'/></svg>");
      background-repeat: no-repeat; background-position: right 1rem center; transition: all 0.3s ease;
    }
    select:hover { border-color: var(--primary); box-shadow: 0 0 15px var(--primary-glow); }
    #swap {
      width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(135deg, var(--secondary), var(--primary));
      border: none; color: white; font-size: 1.5rem; cursor: pointer; display: flex; align-items: center; justify-content: center;
      transition: all 0.3s ease; animation: pulse 2s infinite; box-shadow: 0 0 20px var(--primary-glow);
    }
    #swap:hover { transform: rotate(180deg) scale(1.1); }
    #themeToggle {
      background: var(--bg-surface-light); border: 1px solid var(--border); color: var(--text);
      padding: 0.8rem 1.2rem; border-radius: 30px; font-size: 1rem; cursor: pointer;
    }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem; }
    .textarea-wrapper { position: relative; display: flex; flex-direction: column; }
    textarea {
      min-height: 450px; background: var(--bg-surface); border: 1px solid var(--border); color: var(--text);
      padding: 1.5rem; border-radius: 20px; font-size: 1rem; line-height: 1.6; resize: vertical; transition: all 0.3s ease;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3); backdrop-filter: blur(10px); -webkit-appearance: none;
      width: 100%; box-sizing: border-box;
    }
    textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 30px var(--primary-glow); transform: translateY(-2px); }
    textarea::placeholder { color: var(--text-dim); opacity: 0.5; }
    #output { background: linear-gradient(135deg, var(--bg-surface), #1a1a2a); }
    .light-theme #output { background: linear-gradient(135deg, #ffffff, #f0f0ff); }
    .char-counter { text-align: right; font-size: 0.8rem; color: var(--text-dim); margin-top: 0.2rem; margin-right: 0.5rem; }
    .warning { color: #fbbf24; font-size: 0.85rem; margin-top: 0.2rem; text-align: right; }
    .action-bar { display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap; margin: 2rem 0; }
    button {
      background: linear-gradient(135deg, var(--secondary), var(--primary)); border: none; color: white;
      padding: 1rem 2rem; border-radius: 50px; font-size: 1rem; font-weight: 600; cursor: pointer;
      display: inline-flex; align-items: center; gap: 0.8rem; transition: all 0.3s ease;
      box-shadow: 0 5px 15px rgba(124,58,237,0.3); position: relative; overflow: hidden; -webkit-tap-highlight-color: transparent;
    }
    button::before {
      content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent); transition: left 0.5s ease;
    }
    button:hover::before { left: 100%; }
    button:hover { transform: translateY(-3px); box-shadow: 0 10px 25px var(--primary-glow); }
    button i { font-size: 1.2rem; }
    #clear { background: var(--bg-surface-light); box-shadow: none; border: 1px solid var(--border); }
    #clear:hover { background: var(--error); border-color: var(--error); }
    #abort { background: #444; }
    #voiceBtn, #ocrBtn, #speakBtn, #copy {
      background: var(--bg-surface-light); border: 1px solid var(--border); color: var(--text);
      padding: 0.5rem 1rem; font-size: 0.9rem;
    }
    #voiceBtn:hover, #ocrBtn:hover, #speakBtn:hover, #copy:hover {
      background: var(--primary); color: white;
    }
    .drop-zone {
      border: 2px dashed var(--primary); background: linear-gradient(135deg, rgba(124,58,237,0.1), rgba(168,85,247,0.1));
      padding: 3rem; text-align: center; border-radius: 30px; cursor: pointer; margin: 2rem 0; transition: all 0.3s ease;
      backdrop-filter: blur(5px); position: relative; overflow: hidden;
    }
    .drop-zone::before {
      content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
      background: radial-gradient(circle, rgba(168,85,247,0.1) 0%, transparent 70%); opacity: 0; transition: opacity 0.5s ease;
    }
    .drop-zone:hover::before { opacity: 1; }
    .drop-zone:hover {
      border-color: var(--secondary); background: linear-gradient(135deg, rgba(124,58,237,0.2), rgba(168,85,247,0.2));
      transform: scale(1.02); box-shadow: 0 0 40px var(--primary-glow);
    }
    .drop-zone i { font-size: 3rem; color: var(--primary); margin-bottom: 1rem; display: block; }
    .drop-zone span { font-size: 1.2rem; color: var(--text-dim); }
    #progress { height: 8px; background: var(--bg-surface-light); border-radius: 10px; overflow: hidden; margin: 2rem 0 1rem; box-shadow: inset 0 2px 4px rgba(0,0,0,0.5); }
    #bar {
      height: 100%; width: 0%; background: linear-gradient(90deg, var(--secondary), var(--primary), #d946ef);
      background-size: 200% 200%; animation: gradientMove 2s ease infinite; border-radius: 10px;
      box-shadow: 0 0 20px var(--primary); transition: width 0.4s ease;
    }
    @keyframes gradientMove { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
    .status {
      text-align: center; color: var(--text-dim); font-size: 1rem; padding: 1rem;
      border-radius: 30px; background: var(--bg-surface); border: 1px solid var(--border);
      margin-top: 1rem; backdrop-filter: blur(5px);
    }
    .status i { color: var(--primary); margin-right: 0.5rem; }
    .file-info { margin-top: 1rem; padding: 0.8rem; background: rgba(168,85,247,0.1); border-radius: 20px; font-size: 0.9rem; color: var(--text-dim); display: inline-block; }
    #historyList, #glossaryList {
      max-height: 200px; overflow-y: auto; list-style: none; padding: 0;
      border: 1px solid var(--border); border-radius: 8px; background: var(--bg-surface-light);
    }
    #historyList li, #glossaryList li {
      padding: 0.5rem; border-bottom: 1px solid var(--border); cursor: pointer;
    }
    #historyList li:hover, #glossaryList li:hover {
      background: var(--primary); color: white;
    }
    @media (max-width:768px){ body{padding:1rem;} h1{font-size:2.2rem; white-space:normal;} h1 i{font-size:2rem;} .grid{grid-template-columns:1fr;} .language-selector{border-radius:30px; padding:1rem;} select{min-width:140px;} }
    @media (max-width:480px){ body{padding:0.8rem;} h1{font-size:1.8rem;} .badge{padding:0.3rem 0.8rem; font-size:0.8rem;} select{min-width:120px; padding:0.6rem 1rem;} button{padding:0.8rem 1.2rem;} .drop-zone{padding:2rem;} }
    ::-webkit-scrollbar { width: 10px; height: 10px; }
    ::-webkit-scrollbar-track { background: var(--bg-surface); }
    ::-webkit-scrollbar-thumb { background: linear-gradient(135deg, var(--secondary), var(--primary)); border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--primary); }
  </style>
</head>
<body>
<main>
  <h1><i class="fas fa-skull"></i> NPC Translator <i class="fas fa-skull"></i></h1>
  <div class="badge-container">
    <span class="badge"><i class="fas fa-file-pdf"></i> PDF</span>
    <span class="badge"><i class="fas fa-book"></i> EPUB</span>
    <span class="badge"><i class="fas fa-file-text"></i> TXT</span>
    <span class="badge"><i class="fas fa-file-word"></i> DOCX</span>
    <span class="badge"><i class="fas fa-image"></i> OCR</span>
    <span class="badge"><i class="fas fa-microphone"></i> VOCE</span>
  </div>

  <div class="language-selector">
    <select id="from">
      <option value="auto">ğŸŒ Auto (rileva)</option>
      <option value="en">ğŸ‡¬ğŸ‡§ Inglese</option>
      <option value="it">ğŸ‡®ğŸ‡¹ Italiano</option>
      <option value="la">ğŸ›ï¸ Latino</option>
      <option value="yi">ğŸ“œ Yiddish</option>
      <option value="he">âœ¡ï¸ Ebraico</option>
      <option value="ar">ğŸ•Œ Arabo</option>
      <option value="fr">ğŸ‡«ğŸ‡· Francese</option>
      <option value="es">ğŸ‡ªğŸ‡¸ Spagnolo</option>
      <option value="de">ğŸ‡©ğŸ‡ª Tedesco</option>
      <option value="pt">ğŸ‡µğŸ‡¹ Portoghese</option>
      <option value="ru">ğŸ‡·ğŸ‡º Russo</option>
      <option value="zh-CN">ğŸ‡¨ğŸ‡³ Cinese</option>
      <option value="ja">ğŸ‡¯ğŸ‡µ Giapponese</option>
    </select>
    <button id="swap"><i class="fas fa-exchange-alt"></i></button>
    <select id="to">
      <option value="it" selected>ğŸ‡®ğŸ‡¹ Italiano</option>
      <option value="en">ğŸ‡¬ğŸ‡§ Inglese</option>
      <option value="la">ğŸ›ï¸ Latino</option>
      <option value="yi">ğŸ“œ Yiddish</option>
      <option value="he">âœ¡ï¸ Ebraico</option>
      <option value="ar">ğŸ•Œ Arabo</option>
      <option value="fr">ğŸ‡«ğŸ‡· Francese</option>
      <option value="es">ğŸ‡ªğŸ‡¸ Spagnolo</option>
      <option value="de">ğŸ‡©ğŸ‡ª Tedesco</option>
      <option value="pt">ğŸ‡µğŸ‡¹ Portoghese</option>
      <option value="ru">ğŸ‡·ğŸ‡º Russo</option>
      <option value="zh-CN">ğŸ‡¨ğŸ‡³ Cinese</option>
      <option value="ja">ğŸ‡¯ğŸ‡µ Giapponese</option>
    </select>
    <button id="themeToggle" title="Cambia tema"><i class="fas fa-sun"></i></button>
  </div>

  <div class="grid">
    <div class="textarea-wrapper">
      <textarea id="input" placeholder="ğŸ“ Incolla testo, parla, trascina file o immagini..."></textarea>
      <div class="char-counter" id="inputCounter">0 Â· 0</div>
      <div id="inputWarning" class="warning"></div>
      <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
        <button id="voiceBtn" title="Dettatura"><i class="fas fa-microphone"></i> Dettatura</button>
        <button id="ocrBtn" title="OCR da immagine"><i class="fas fa-image"></i> OCR</button>
      </div>
    </div>
    <div class="textarea-wrapper">
      <textarea id="output" readonly placeholder="âœ¨ Traduzione..."></textarea>
      <div class="char-counter" id="outputCounter">0 Â· 0</div>
      <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
        <button id="speakBtn" title="Ascolta traduzione"><i class="fas fa-volume-up"></i> Ascolta</button>
        <button id="copy"><i class="fas fa-copy"></i> Copia</button>
      </div>
    </div>
  </div>

  <div class="action-bar">
    <button id="translate"><i class="fas fa-play"></i> Traduci</button>
    <button id="abort" style="display: none;"><i class="fas fa-stop"></i> Annulla</button>
    <button id="download"><i class="fas fa-download"></i> Scarica TXT</button>
    <button id="clear"><i class="fas fa-eraser"></i> Pulisci</button>
    <button id="batchBtn" title="Traduci piÃ¹ file e scarica ZIP"><i class="fas fa-layer-group"></i> Batch</button>
  </div>

  <div class="drop-zone" id="drop">
    <i class="fas fa-cloud-upload-alt"></i>
    <span>Trascina file (PDF, EPUB, DOCX, TXT, IMMAGINI) o cartelle</span>
    <input type="file" id="file" accept=".pdf,.epub,.txt,.docx,image/*" multiple hidden>
    <div class="file-info" id="fileInfo"></div>
  </div>

  <div id="progress"><div id="bar"></div></div>
  <div class="status" id="status"><i class="fas fa-check-circle"></i> Sistema pronto</div>

  <!-- Pannelli laterali -->
  <div style="display: flex; gap: 1rem; margin-top: 2rem;">
    <div style="flex:1; background: var(--bg-surface); border-radius: 12px; padding: 1rem;">
      <h3><i class="fas fa-history"></i> Cronologia <button id="clearHistory" style="float:right; padding:0.2rem 0.5rem;">ğŸ—‘ï¸</button></h3>
      <ul id="historyList" style="max-height: 200px; overflow-y: auto; list-style: none; padding:0;"></ul>
    </div>
    <div style="flex:1; background: var(--bg-surface); border-radius: 12px; padding: 1rem;">
      <h3><i class="fas fa-book"></i> Glossario <button id="addGlossary" style="float:right;">â•</button></h3>
      <ul id="glossaryList" style="max-height: 200px; overflow-y: auto; list-style: none; padding:0;"></ul>
    </div>
  </div>
</main>

<script type="importmap">
  { "imports": { "pdfjs-dist": "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.0.379/pdf.min.mjs" } }
</script>
<script type="module">
  import * as pdfjs from 'pdfjs-dist';
  pdfjs.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.0.379/pdf.worker.min.mjs';

  // ---------- ELEMENTI DOM ----------
  const from = document.getElementById('from');
  const to = document.getElementById('to');
  const input = document.getElementById('input');
  const output = document.getElementById('output');
  const statusDiv = document.getElementById('status');
  const bar = document.getElementById('bar');
  const fileInput = document.getElementById('file');
  const drop = document.getElementById('drop');
  const fileInfo = document.getElementById('fileInfo');
  const translateBtn = document.getElementById('translate');
  const abortBtn = document.getElementById('abort');
  const copyBtn = document.getElementById('copy');
  const inputCounter = document.getElementById('inputCounter');
  const outputCounter = document.getElementById('outputCounter');
  const inputWarning = document.getElementById('inputWarning');
  const voiceBtn = document.getElementById('voiceBtn');
  const speakBtn = document.getElementById('speakBtn');
  const ocrBtn = document.getElementById('ocrBtn');
  const themeToggle = document.getElementById('themeToggle');
  const batchBtn = document.getElementById('batchBtn');
  const clearHistoryBtn = document.getElementById('clearHistory');
  const addGlossaryBtn = document.getElementById('addGlossary');
  const historyList = document.getElementById('historyList');
  const glossaryList = document.getElementById('glossaryList');

  let abortTranslation = false;
  let isTranslating = false;

  // ---------- PREFERENZE ----------
  function loadPrefs() {
    try {
      if (localStorage.getItem('npc_from')) from.value = localStorage.getItem('npc_from');
      if (localStorage.getItem('npc_to')) to.value = localStorage.getItem('npc_to');
      if (localStorage.getItem('npc_theme') === 'light') document.body.classList.add('light-theme');
    } catch (e) {}
  }
  function saveLangPrefs() {
    try {
      localStorage.setItem('npc_from', from.value);
      localStorage.setItem('npc_to', to.value);
    } catch (e) {}
  }
  loadPrefs();

  themeToggle.onclick = () => {
    document.body.classList.toggle('light-theme');
    localStorage.setItem('npc_theme', document.body.classList.contains('light-theme') ? 'light' : 'dark');
  };

  // ---------- FUNZIONI BASE ----------
  function setStatus(msg, isError = false) {
    let icon = 'sync-alt';
    if (!isError) {
      const lower = msg.toLowerCase();
      if (lower.includes('complet') || lower.includes('pronto') || lower.includes('scaricato') || lower.includes('caricato')) icon = 'check-circle';
    }
    statusDiv.innerHTML = isError
      ? `<i class="fas fa-exclamation-triangle"></i> ${msg}`
      : `<i class="fas fa-${icon}"></i> ${msg}`;
    statusDiv.style.color = isError ? 'var(--error)' : 'var(--text-dim)';
  }

  function updateCounters() {
    const inText = input.value;
    const outText = output.value;
    const inChars = inText.length;
    const inWords = inText.trim() ? inText.trim().split(/\s+/).length : 0;
    inputCounter.textContent = `${inChars} caratteri Â· ${inWords} parole`;
    inputWarning.textContent = (inChars > 100000) ? 'âš ï¸ Testo molto lungo, la traduzione potrebbe richiedere tempo.' : '';
    const outChars = outText.length;
    const outWords = outText.trim() ? outText.trim().split(/\s+/).length : 0;
    outputCounter.textContent = `${outChars} caratteri Â· ${outWords} parole`;
  }
  input.addEventListener('input', updateCounters);
  output.addEventListener('input', updateCounters);
  updateCounters();

  function checkRTL() {
    const rtlLangs = ['yi', 'he', 'ar'];
    if (rtlLangs.includes(to.value)) {
      output.style.direction = 'rtl';
      output.style.fontFamily = "'Noto Sans Arabic', 'Noto Sans Hebrew', sans-serif";
      output.style.fontSize = '1.2rem';
    } else {
      output.style.direction = 'ltr';
      output.style.fontFamily = 'Inter, system-ui, sans-serif';
      output.style.fontSize = '1rem';
    }
  }

  document.getElementById('swap').onclick = () => {
    [from.value, to.value] = [to.value, from.value];
    if (output.value.trim()) [input.value, output.value] = [output.value, input.value];
    checkRTL(); saveLangPrefs(); updateCounters();
  };
  document.getElementById('clear').onclick = () => {
    input.value = ""; output.value = ""; fileInfo.textContent = "";
    setStatus("Sistema pronto"); bar.style.width = "0%"; updateCounters();
  };
  copyBtn.onclick = () => {
    if (!output.value.trim()) { setStatus("âŒ Nessun testo da copiare", true); return; }
    navigator.clipboard.writeText(output.value).then(() => setStatus("âœ… Copiato"));
  };
  document.getElementById('download').onclick = () => {
    if (!output.value.trim()) { setStatus("âŒ Nessun testo", true); return; }
    const blob = new Blob([output.value], { type: "text/plain" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "traduzione_npc.txt";
    a.click(); URL.revokeObjectURL(a.href);
    setStatus("âœ… File scaricato");
  };

  // ---------- TRADUZIONE CON SERVER ----------
  async function translateWithServer(text, sourceLang, targetLang) {
    const sl = sourceLang === 'auto' ? 'auto' : (['yi', 'he'].includes(sourceLang) ? 'he' : sourceLang);
    const tl = ['yi', 'he'].includes(targetLang) ? 'he' : targetLang;
    const timeout = (ms) => new Promise((_, reject) => setTimeout(() => reject(new Error('Timeout')), ms));
    const servers = [
      async () => {
        const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=${sl}&tl=${tl}&dt=t&q=${encodeURIComponent(text)}`;
        const res = await Promise.race([fetch(url), timeout(5000)]);
        const data = await res.json();
        return data[0].map(x => x[0]).join('');
      },
      async () => {
        const url = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=${sl}|${tl}`;
        const res = await Promise.race([fetch(url), timeout(5000)]);
        const data = await res.json();
        return data.responseData.translatedText;
      },
      async () => {
        const url = `https://lingva.ml/api/v1/${sl}/${tl}/${encodeURIComponent(text)}`;
        const res = await Promise.race([fetch(url), timeout(5000)]);
        const data = await res.json();
        return data.translation;
      }
    ];
    for (const server of servers) {
      try { return await server(); } catch (e) { /* fallback */ }
    }
    throw new Error('Nessun server disponibile');
  }

  async function translateText(text) {
    const MAX = 1500;
    const parts = [];
    for (let i = 0; i < text.length; i += MAX) parts.push(text.slice(i, i + MAX));
    let result = "";
    for (let i = 0; i < parts.length; i++) {
      if (abortTranslation) throw new Error('Annullato');
      setStatus(`Traduzione ${i + 1}/${parts.length}`);
      bar.style.width = ((i + 1) / parts.length * 100) + "%";
      const translated = await translateWithServer(parts[i], from.value, to.value);
      result += translated + (i < parts.length - 1 ? " " : "");
      if (i < parts.length - 1 && !abortTranslation) await new Promise(r => setTimeout(r, 500));
    }
    return result;
  }

  translateBtn.onclick = async () => {
    if (!input.value.trim()) { setStatus("âŒ Inserisci testo", true); return; }
    if (isTranslating) { setStatus("Traduzione giÃ  in corso", true); return; }
    abortTranslation = false;
    isTranslating = true;
    translateBtn.disabled = true;
    abortBtn.style.display = 'inline-flex';
    setStatus("Traduzione in corso...");
    bar.style.width = "0%";
    try {
      let translated = await translateText(input.value);
      if (!abortTranslation) {
        output.value = translated;
        setStatus("âœ… Completata!");
        bar.style.width = "100%";
        saveToHistory(input.value, translated);
        output.value = await applyGlossary(output.value, to.value);
      } else {
        setStatus("â›” Annullata");
      }
      checkRTL(); updateCounters();
    } catch (e) {
      setStatus("âŒ Errore: " + e.message, true);
      bar.style.width = "0%";
    } finally {
      isTranslating = false;
      translateBtn.disabled = false;
      abortBtn.style.display = 'none';
    }
  };

  abortBtn.onclick = () => { abortTranslation = true; setStatus("Annullamento..."); };

  // ---------- INPUT VOCALE ----------
  voiceBtn.onclick = () => {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) { setStatus("âŒ Riconoscimento vocale non supportato", true); return; }
    const recognition = new SpeechRecognition();
    recognition.lang = from.value === 'auto' ? 'it-IT' : from.value;
    recognition.continuous = false;
    recognition.interimResults = false;
    recognition.onresult = (e) => {
      const transcript = e.results[0][0].transcript;
      input.value += (input.value ? '\n' : '') + transcript;
      updateCounters();
    };
    recognition.start();
  };

  // ---------- OUTPUT VOCALE ----------
  speakBtn.onclick = () => {
    if (!output.value.trim()) { setStatus("âŒ Nessuna traduzione da ascoltare", true); return; }
    const utterance = new SpeechSynthesisUtterance(output.value);
    utterance.lang = to.value;
    speechSynthesis.speak(utterance);
  };

  // ---------- OCR ----------
  ocrBtn.onclick = () => {
    const inputFile = document.createElement('input');
    inputFile.type = 'file';
    inputFile.accept = 'image/*';
    inputFile.onchange = async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      setStatus("OCR in corso...");
      try {
        const { data: { text } } = await Tesseract.recognize(file, 'ita+eng', { logger: m => console.log(m) });
        input.value += (input.value ? '\n' : '') + text;
        setStatus("âœ… OCR completato");
        updateCounters();
      } catch (err) {
        setStatus("âŒ OCR fallito: " + err.message, true);
      }
    };
    inputFile.click();
  };

  // ---------- GESTIONE FILE MIGLIORATA ----------
  async function readFile(file) {
    const name = file.name.toLowerCase();
    try {
      if (name.endsWith('.txt')) {
        return await file.text();
      }
      if (name.endsWith('.pdf')) {
        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjs.getDocument({ data: arrayBuffer }).promise;
        let text = "";
        for (let i = 1; i <= pdf.numPages; i++) {
          const page = await pdf.getPage(i);
          const content = await page.getTextContent();
          text += content.items.map(it => it.str).join(" ") + "\n\n";
        }
        return text;
      }
      if (name.endsWith('.docx')) {
        const arrayBuffer = await file.arrayBuffer();
        const result = await mammoth.extractRawText({ arrayBuffer });
        return result.value;
      }
      if (name.endsWith('.epub')) {
        const arrayBuffer = await file.arrayBuffer();
        const zip = await JSZip.loadAsync(arrayBuffer);
        let fullText = '';
        let count = 0;
        for (const [filename, zipEntry] of Object.entries(zip.files)) {
          if (filename.match(/\.(xhtml|html|htm)$/i) && !zipEntry.dir) {
            try {
              const content = await zipEntry.async('string');
              const parser = new DOMParser();
              const doc = parser.parseFromString(content, 'text/html');
              // Rimuovi elementi indesiderati
              doc.querySelectorAll('nav, script, style, header, footer, [role="doc-toc"], [role="navigation"]').forEach(el => el.remove());
              const bodyText = doc.body?.textContent || '';
              if (bodyText.trim().length > 0) {
                fullText += `\n\n--- ${filename} ---\n${bodyText.trim()}\n`;
                count++;
              }
            } catch (e) {
              console.warn(`Errore parsing ${filename}:`, e);
            }
          }
        }
        if (fullText.trim()) {
          return fullText.trim() + `\n\n[Estratti ${count} file HTML]`;
        }
        return '[EPUB: nessun testo leggibile]';
      }
      if (file.type.startsWith('image/')) {
        setStatus(`OCR su ${file.name}...`);
        const { data: { text } } = await Tesseract.recognize(file, 'ita+eng');
        return text;
      }
      throw new Error('Formato non supportato');
    } catch (err) {
      throw new Error(`Errore lettura ${file.name}: ${err.message}`);
    }
  }

  async function handleFiles(files) {
    if (!files || files.length === 0) return;
    fileInfo.textContent = `ğŸ“‚ Caricamento ${files.length} file...`;
    let successCount = 0;
    for (let i = 0; i < files.length; i++) {
      const file = files[i];
      try {
        setStatus(`Lettura ${file.name} (${i+1}/${files.length})...`);
        bar.style.width = ((i+1) / files.length * 100) + "%";
        const text = await readFile(file);
        input.value += (input.value ? "\n\n" : "") + `[${file.name}]\n${text}`;
        successCount++;
        fileInfo.textContent = `âœ… ${file.name} caricato`;
      } catch (err) {
        fileInfo.textContent = `âŒ Errore: ${err.message}`;
        setStatus(`Errore: ${err.message}`, true);
      }
    }
    bar.style.width = "0%";
    setStatus(`âœ… ${successCount}/${files.length} file caricati`);
    updateCounters();
  }

  // Aggiunto: clic sulla zona di drop apre la finestra di selezione file
  drop.onclick = () => fileInput.click();

  drop.ondrop = (e) => { e.preventDefault(); handleFiles(e.dataTransfer.files); };
  drop.ondragover = (e) => e.preventDefault();
  fileInput.onchange = (e) => handleFiles(e.target.files);

  // ---------- CRONOLOGIA IndexedDB ----------
  function openDB() {
    return new Promise((resolve, reject) => {
      const req = indexedDB.open('NPCTranslator', 1);
      req.onupgradeneeded = (e) => {
        const db = e.target.result;
        if (!db.objectStoreNames.contains('history')) db.createObjectStore('history', { keyPath: 'id', autoIncrement: true });
        if (!db.objectStoreNames.contains('glossary')) {
          const store = db.createObjectStore('glossary', { keyPath: 'id', autoIncrement: true });
          store.createIndex('term', 'term', { unique: false });
        }
      };
      req.onsuccess = () => resolve(req.result);
      req.onerror = () => reject(req.error);
    });
  }

  async function saveToHistory(original, translated) {
    const db = await openDB();
    const tx = db.transaction('history', 'readwrite');
    tx.objectStore('history').add({ original, translated, date: new Date() });
    tx.oncomplete = () => loadHistory();
  }

  async function loadHistory() {
    const db = await openDB();
    const tx = db.transaction('history', 'readonly');
    const store = tx.objectStore('history');
    const all = await new Promise((res) => { const req = store.getAll(); req.onsuccess = () => res(req.result); });
    historyList.innerHTML = all.reverse().slice(0, 10).map(item =>
      `<li onclick="loadHistoryItem(${item.id})" style="cursor:pointer; border-bottom:1px solid var(--border); padding:0.5rem;">${item.original.substring(0,30)}â€¦ â†’ ${item.translated.substring(0,30)}â€¦</li>`
    ).join('');
  }

  window.loadHistoryItem = async (id) => {
    const db = await openDB();
    const tx = db.transaction('history', 'readonly');
    const item = await new Promise((res) => { const req = tx.objectStore('history').get(id); req.onsuccess = () => res(req.result); });
    input.value = item.original;
    output.value = item.translated;
    updateCounters(); checkRTL();
  };

  clearHistoryBtn.onclick = async () => {
    if (!confirm('Cancellare tutta la cronologia?')) return;
    const db = await openDB();
    const tx = db.transaction('history', 'readwrite');
    tx.objectStore('history').clear();
    tx.oncomplete = () => loadHistory();
  };

  // ---------- GLOSSARIO ----------
  async function loadGlossary() {
    const db = await openDB();
    const tx = db.transaction('glossary', 'readonly');
    const store = tx.objectStore('glossary');
    const all = await new Promise((res) => { const req = store.getAll(); req.onsuccess = () => res(req.result); });
    glossaryList.innerHTML = all.map(item =>
      `<li style="border-bottom:1px solid var(--border); padding:0.3rem;">${item.term} â†’ ${item.translation} <button class="delGloss" data-id="${item.id}">âŒ</button></li>`
    ).join('');
    document.querySelectorAll('.delGloss').forEach(btn => {
      btn.onclick = async (e) => {
        e.stopPropagation();
        const id = Number(btn.dataset.id);
        const db = await openDB();
        const tx = db.transaction('glossary', 'readwrite');
        tx.objectStore('glossary').delete(id);
        tx.oncomplete = () => loadGlossary();
      };
    });
  }

  addGlossaryBtn.onclick = () => {
    const term = prompt('Termine originale:');
    if (!term) return;
    const translation = prompt('Traduzione desiderata:');
    if (!translation) return;
    (async () => {
      const db = await openDB();
      const tx = db.transaction('glossary', 'readwrite');
      tx.objectStore('glossary').add({ term, translation, targetLang: to.value });
      tx.oncomplete = () => loadGlossary();
    })();
  };

  async function applyGlossary(text, targetLang) {
    const db = await openDB();
    const tx = db.transaction('glossary', 'readonly');
    const store = tx.objectStore('glossary');
    const all = await new Promise((res) => { const req = store.getAll(); req.onsuccess = () => res(req.result); });
    let result = text;
    for (const entry of all) {
      if (entry.targetLang === targetLang) {
        const regex = new RegExp('\\b' + entry.term + '\\b', 'gi');
        result = result.replace(regex, entry.translation);
      }
    }
    return result;
  }

  // ---------- BATCH ----------
  batchBtn.onclick = () => {
    const inputFile = document.createElement('input');
    inputFile.type = 'file';
    inputFile.accept = '.pdf,.epub,.txt,.docx,image/*';
    inputFile.multiple = true;
    inputFile.onchange = async (e) => {
      const files = Array.from(e.target.files);
      if (files.length === 0) return;
      setStatus(`Batch: traduzione di ${files.length} file...`);
      const zip = new JSZip();
      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        setStatus(`Batch: elaborazione ${file.name} (${i+1}/${files.length})...`);
        bar.style.width = ((i+1)/files.length * 100) + '%';
        try {
          const text = await readFile(file);
          const translated = await translateText(text);
          zip.file(`tradotto_${file.name}.txt`, translated);
        } catch (err) {
          zip.file(`ERRORE_${file.name}.txt`, `Errore: ${err.message}`);
        }
      }
      setStatus("Generazione ZIP...");
      const blob = await zip.generateAsync({ type: 'blob' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `traduzioni_batch_${new Date().toISOString().slice(0,10)}.zip`;
      a.click();
      URL.revokeObjectURL(a.href);
      setStatus("âœ… Batch completato");
      bar.style.width = "0%";
    };
    inputFile.click();
  };

  // ---------- SCORCIATOIE TASTIERA ----------
  document.addEventListener('keydown', (e) => {
    if (e.ctrlKey && e.key === 'Enter') { e.preventDefault(); translateBtn.click(); }
    if (e.ctrlKey && e.shiftKey && e.key === 'C') { e.preventDefault(); copyBtn.click(); }
    if (e.key === 'Escape' && isTranslating) abortBtn.click();
  });

  // ---------- AVVIO ----------
  to.addEventListener('change', () => { checkRTL(); saveLangPrefs(); });
  from.addEventListener('change', saveLangPrefs);
  checkRTL();
  loadHistory();
  loadGlossary();

  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('sw.js').catch(e => console.log('SW non registrato', e));
    });
  }
</script>
</body>
</html>
